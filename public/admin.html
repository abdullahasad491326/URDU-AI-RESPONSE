<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-color: #f4f6f8;
      --card-bg: #ffffff;
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --text-color: #333333;
      --text-muted: #888888;
      --success: #28a745;
      --success-hover: #218838;
      --danger: #dc3545;
      --danger-hover: #c82333;
      --border-color: #e0e0e0;
      --blocked-row-bg: #fff0f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .dashboard-container {
      width: 100%;
      max-width: 1100px;
      display: grid;
      gap: 15px;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .header {
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .header p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background-color: #fafafa;
      color: var(--text-color);
      outline: none;
      transition: border-color 0.2s ease;
    }

    .form-input:focus {
      border-color: var(--primary-color);
    }

    .btn {
      width: 100%;
      padding: 10px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background-color: var(--primary-hover);
    }

    .btn-success {
      background-color: var(--success);
      color: #fff;
    }

    .btn-success:hover:not(:disabled) {
      background-color: var(--success-hover);
    }

    .btn-danger {
      background-color: var(--danger);
      color: #fff;
    }

    .btn-danger:hover:not(:disabled) {
      background-color: var(--danger-hover);
    }

    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: #5a6268;
    }

    .btn:disabled {
      background-color: #e9ecef;
      color: #999;
      cursor: not-allowed;
    }

    .login-form {
      max-width: 350px;
      margin: 10px auto;
    }

    .login-message {
      font-size: 0.85rem;
      text-align: center;
      color: var(--danger);
      min-height: 1.2em;
    }

    #adminSection.hidden {
      display: none;
    }

    .admin-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .status-control, .filter-control {
      flex-grow: 1;
    }

    .admin-controls h2 {
      margin-bottom: 8px;
    }

    .filter-group {
      display: flex;
      gap: 8px;
    }

    .filter-group input {
      flex-grow: 1;
    }

    .logs-section h2 {
      margin-bottom: 10px;
    }

    .table-desktop {
      display: block;
      overflow-x: auto;
      border-radius: 8px;
    }

    .table-desktop table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    
    .table-desktop th, .table-desktop td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    .table-desktop thead {
      background-color: #e9ecef;
    }

    .table-desktop tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .table-desktop tbody tr.blocked-ip {
      background-color: var(--blocked-row-bg);
    }

    .view-message-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }

    .btn-group {
      display: flex;
      gap: 5px;
    }

    .table-mobile {
      display: none;
    }

    .log-card {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
    }

    .log-card-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .log-card-item strong {
      color: var(--primary-color);
      flex-basis: 30%;
    }

    .log-card-item span {
      text-align: right;
      flex-basis: 70%;
    }
    
    .log-card-item button {
        margin-left: auto;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 10px;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 20px;
      max-width: 450px;
      width: 100%;
      border-radius: 8px;
      position: relative;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
    }
    
    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    
    .modal-message-body {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 250px;
      overflow-y: auto;
      font-family: monospace;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .stats-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .stats-card {
        flex-grow: 1;
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .stats-card h3 {
        font-size: 1rem;
        color: var(--text-muted);
        margin-bottom: 5px;
    }

    .stats-card p {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .table-desktop {
        display: none;
      }
      .table-mobile {
        display: block;
      }
      .btn {
        width: auto;
        flex: 1;
      }
      .btn-group {
        flex-direction: row;
      }
      .filter-group {
        flex-direction: column;
      }
      .filter-group .btn {
        width: 100%;
      }
      .admin-controls {
        flex-direction: column;
      }
      .stats-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <main class="dashboard-container">
    <section id="loginSection">
      <header class="card header">
        <h1>Admin Login</h1>
        <p>Access the SMS Service Panel</p>
      </header>
      <div class="card">
        <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
          <div class="form-group">
            <input class="form-input" type="text" id="username" placeholder="Username" required autocomplete="username" />
          </div>
          <div class="form-group">
            <input class="form-input" type="password" id="password" placeholder="Password" required autocomplete="current-password" />
          </div>
          <button type="submit" id="loginButton" class="btn btn-primary">Login</button>
          <p id="loginMessage" class="login-message"></p>
        </form>
      </div>
    </section>

    <section id="adminSection" class="hidden">
      <header class="card header">
        <h1>Admin Dashboard</h1>
        <p>Manage SMS Service and View Logs</p>
      </header>

      <div class="card admin-controls">
        <div class="status-control">
          <h2>SMS Service Status</h2>
          <button id="toggleButton" class="btn btn-secondary">Loading...</button>
        </div>
        <div class="filter-control">
          <h2>Filter Logs</h2>
          <div class="filter-group">
            <input type="text" id="filterInput" class="form-input" placeholder="Filter by IP, Number, or Message" />
            <button id="filterButton" class="btn btn-primary">Filter</button>
            <button id="clearFilterButton" class="btn btn-secondary">Clear</button>
          </div>
        </div>
      </div>

      <div class="card stats-card-container">
        <h2>Statistics</h2>
        <div class="stats-container">
          <div class="stats-card">
            <h3>Total Messages Sent</h3>
            <p id="totalMessages">0</p>
          </div>
          <div class="stats-card">
            <h3>Total Visitors</h3>
            <p id="totalVisitors">0</p>
          </div>
        </div>
      </div>

      <div class="card logs-section">
        <h2>SMS Logs</h2>
        <div class="table-desktop">
          <table>
            <thead>
              <tr>
                <th>IP Address</th>
                <th>Number</th>
                <th>Message</th>
                <th>Timestamp</th>
                <th>Type</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="logsTableBody">
              <tr>
                <td colspan="6" style="text-align:center; color: var(--text-muted); padding: 20px;">No logs to display.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="logsListBody" class="table-mobile">
          <div class="log-card">
            <div class="log-card-item">
              <span style="color: var(--text-muted);">No logs to display.</span>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>
  <div id="messageModal" class="modal-overlay">
    <div class="modal-content">
      <button id="modalCloseBtn" aria-label="Close full message" class="modal-close-btn">&times;</button>
      <h3>Full Message</h3>
      <pre id="modalMessage" class="modal-message-body"></pre>
    </div>
  </div>
  <script>
    // Variables
    const loginSection = document.getElementById('loginSection');
    const adminSection = document.getElementById('adminSection');
    const loginButton = document.getElementById('loginButton');
    const toggleButton = document.getElementById('toggleButton');
    const logsTableBody = document.getElementById('logsTableBody');
    const logsListBody = document.getElementById('logsListBody');
    const loginMessage = document.getElementById('loginMessage');
    const filterInput = document.getElementById('filterInput');
    const filterButton = document.getElementById('filterButton');
    const clearFilterButton = document.getElementById('clearFilterButton');
    const messageModal = document.getElementById('messageModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalMessage = document.getElementById('modalMessage');
    const totalMessagesElement = document.getElementById('totalMessages');
    const totalVisitorsElement = document.getElementById('totalVisitors');

    let isLoggedIn = false;
    let allLogs = [];
    let blockedIps = new Set();
    let currentFilteredLogs = [];
    let isMobile = window.innerWidth <= 768;
    
    // --- UTILITY FUNCTIONS ---
    
    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function openMessageModal(message) {
      modalMessage.textContent = message;
      messageModal.style.display = 'flex';
      modalCloseBtn.focus();
    }
    
    function closeMessageModal() {
      messageModal.style.display = 'none';
    }
    
    modalCloseBtn.addEventListener('click', closeMessageModal);
    window.addEventListener('click', (e) => {
      if (e.target === messageModal) closeMessageModal();
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && messageModal.style.display === 'flex') closeMessageModal();
    });

    window.addEventListener('resize', () => {
      const wasMobile = isMobile;
      isMobile = window.innerWidth <= 768;
      if (wasMobile !== isMobile) {
        renderLogs(currentFilteredLogs);
      }
    });

    // --- NEW FUNCTION TO FETCH STATS ---
    async function fetchStatistics() {
      try {
        const res = await fetch('/api/admin/stats');
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (data.success) {
          totalMessagesElement.textContent = data.totalMessages;
          totalVisitorsElement.textContent = data.totalVisitors;
        }
      } catch (error) {
        console.error('Stats fetch failed:', error);
        totalMessagesElement.textContent = 'Error';
        totalVisitorsElement.textContent = 'Error';
      }
    }

    async function updateStatus() {
      try {
        const res = await fetch('/api/admin/status');
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        toggleButton.innerText = data.success ? (data.status ? 'Service ON' : 'Service OFF') : 'Error';
        toggleButton.className = data.success ? (data.status ? 'btn btn-success' : 'btn btn-danger') : 'btn btn-secondary';
      } catch (error) {
        console.error('Status fetch failed:', error);
        toggleButton.innerText = 'Error';
        toggleButton.className = 'btn btn-secondary';
      }
    }

    async function fetchBlockedIps() {
      try {
        const res = await fetch('/api/admin/blocked-ips');
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        blockedIps = new Set(data.success && Array.isArray(data.blockedIps) ? data.blockedIps : []);
      } catch (error) {
        console.error('Blocked IPs fetch failed:', error);
        blockedIps = new Set();
      }
    }

    function renderDesktopTable(logs) {
      logsTableBody.innerHTML = '';
      if (logs.length === 0) {
        logsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: var(--text-muted); padding:20px;">No logs found.</td></tr>`;
        return;
      }
      
      const fragment = document.createDocumentFragment();
      logs.forEach((log) => {
        const isBlocked = blockedIps.has(log.ip);
        const truncated = log.message.length > 30 ? log.message.substring(0,30) + '...' : log.message;
        
        const tr = document.createElement('tr');
        if (isBlocked) {
          tr.classList.add('blocked-ip');
        }
        
        tr.innerHTML = `
          <td>${log.ip}</td>
          <td>${log.mobile}</td>
          <td><button class="view-message-btn" data-message="${escapeHtml(log.message)}">${truncated}</button></td>
          <td>${new Date(log.timestamp).toLocaleString()}</td>
          <td>${log.type}</td>
          <td>
            ${isBlocked
                ? `<button class="btn btn-success btn-unblock" data-ip="${log.ip}">Unblock</button>`
                : `<button class="btn btn-danger btn-block" data-ip="${log.ip}">Block</button>`
            }
          </td>
        `;
        fragment.appendChild(tr);
      });
      logsTableBody.appendChild(fragment);
      setupLogEventListeners();
    }
    
    function renderMobileList(logs) {
      logsListBody.innerHTML = '';
      if (logs.length === 0) {
        logsListBody.innerHTML = `<div class="log-card"><div class="log-card-item"><span style="color: var(--text-muted);">No logs found.</span></div></div>`;
        return;
      }

      const fragment = document.createDocumentFragment();
      logs.forEach((log) => {
        const isBlocked = blockedIps.has(log.ip);
        const truncated = log.message.length > 30 ? log.message.substring(0, 30) + '...' : log.message;
        
        const div = document.createElement('div');
        div.className = 'log-card';
        if (isBlocked) {
          div.style.backgroundColor = 'var(--blocked-row-bg)';
        }

        div.innerHTML = `
          <div class="log-card-item"><strong>IP Address:</strong> <span>${log.ip}</span></div>
          <div class="log-card-item"><strong>Number:</strong> <span>${log.mobile}</span></div>
          <div class="log-card-item"><strong>Message:</strong> <button class="view-message-btn" data-message="${escapeHtml(log.message)}">${truncated}</button></div>
          <div class="log-card-item"><strong>Timestamp:</strong> <span>${new Date(log.timestamp).toLocaleString()}</span></div>
          <div class="log-card-item"><strong>Type:</strong> <span>${log.type}</span></div>
          <div class="log-card-item">
            <div class="btn-group">
              ${isBlocked
                ? `<button class="btn btn-success btn-unblock" data-ip="${log.ip}">Unblock</button>`
                : `<button class="btn btn-danger btn-block" data-ip="${log.ip}">Block</button>`
            }
            </div>
          </div>
        `;
        fragment.appendChild(div);
      });
      logsListBody.appendChild(fragment);
      setupLogEventListeners();
    }
    
    function renderLogs(logs) {
      currentFilteredLogs = logs;
      isMobile = window.innerWidth <= 768; // Check on render
      if (isMobile) {
        renderMobileList(logs);
      } else {
        renderDesktopTable(logs);
      }
    }

    function setupLogEventListeners() {
      document.querySelectorAll('.view-message-btn, .btn-block, .btn-unblock').forEach(btn => {
        btn.removeEventListener('click', handleLogAction);
      });
      
      document.querySelectorAll('.view-message-btn, .btn-block, .btn-unblock').forEach(btn => {
        btn.addEventListener('click', handleLogAction);
      });
    }
    
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function handleLogAction(e) {
      const btn = e.target;
      const ip = btn.getAttribute('data-ip');
      const message = btn.getAttribute('data-message');
      
      if (btn.classList.contains('view-message-btn')) {
        if (message) {
          openMessageModal(message);
        }
      } else if (btn.classList.contains('btn-block')) {
        if (ip && confirm(`Block IP ${ip}?`)) {
          await blockIp(ip);
          await refreshData();
        }
      } else if (btn.classList.contains('btn-unblock')) {
        if (ip && confirm(`Unblock IP ${ip}?`)) {
          await unblockIp(ip);
          await refreshData();
        }
      }
    }

    async function fetchLogs() {
      try {
        const res = await fetch('/api/admin/logs');
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        allLogs = data.success && Array.isArray(data.logs) ? data.logs.reverse() : []; // Reverse to show latest first
        applyFilter();
      } catch (error) {
        console.error('Logs fetch failed:', error);
        if(isMobile) {
            logsListBody.innerHTML = `<div class="log-card"><div class="log-card-item"><span style="color: var(--danger);">Failed to load logs.</span></div></div>`;
        } else {
            logsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: var(--danger); padding:20px;">Failed to load logs.</td></tr>`;
        }
      }
    }

    async function blockIp(ip) {
      try {
        const res = await fetch('/api/admin/block-ip', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip }) });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to block IP');
      } catch (error) {
        alert('Error blocking IP: ' + error.message);
      }
    }
    async function unblockIp(ip) {
      try {
        const res = await fetch('/api/admin/unblock-ip', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip }) });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to unblock IP');
      } catch (error) {
        alert('Error unblocking IP: ' + error.message);
      }
    }

    const applyFilter = () => {
      const filterText = filterInput.value.trim().toLowerCase();
      const filtered = filterText 
        ? allLogs.filter(log =>
            log.ip.toLowerCase().includes(filterText) ||
            log.mobile.toLowerCase().includes(filterText) ||
            log.message.toLowerCase().includes(filterText)
          )
        : allLogs;
      renderLogs(filtered);
    };

    filterButton.addEventListener('click', applyFilter);
    clearFilterButton.addEventListener('click', () => {
      filterInput.value = '';
      applyFilter();
    });
    filterInput.addEventListener('input', debounce(applyFilter, 300));
    
    async function refreshData() {
      await Promise.all([fetchBlockedIps(), fetchLogs(), updateStatus(), fetchStatistics()]);
    }

    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      loginButton.disabled = true;
      loginButton.textContent = 'Logging in...';
      loginMessage.textContent = '';

      try {
        const res = await fetch('/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();
        if (data.success) {
          isLoggedIn = true;
          loginSection.classList.add('hidden');
          adminSection.classList.remove('hidden');
          await refreshData();
        } else {
          loginMessage.textContent = data.message || 'Invalid credentials.';
        }
      } catch (error) {
        loginMessage.textContent = 'An error occurred.';
        console.error('Login error:', error);
      } finally {
        loginButton.disabled = false;
        loginButton.textContent = 'Login';
      }
    }

    toggleButton.addEventListener('click', async () => {
      if (!isLoggedIn) return;
      toggleButton.disabled = true;
      const originalText = toggleButton.textContent;
      toggleButton.textContent = 'Toggling...';
      try {
        const res = await fetch('/api/admin/toggle-sms', { method: 'POST' });
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to toggle service');
        await updateStatus();
      } catch (error) {
        alert('Failed to toggle SMS service: ' + error.message);
        toggleButton.textContent = originalText;
      } finally {
        toggleButton.disabled = false;
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/api/admin/session-check');
        if (res.ok) {
          const data = await res.json();
          if (data.isLoggedIn) {
            isLoggedIn = true;
            loginSection.classList.add('hidden');
            adminSection.classList.remove('hidden');
            await refreshData();
          }
        }
      } catch (error) {
        // This is a normal scenario if no session exists
        console.info('No active admin session found.');
      }
    });

    // Initial check for mobile view on load
    isMobile = window.innerWidth <= 768;
  </script>
</body>
</html>
